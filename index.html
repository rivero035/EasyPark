<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyPark - Aparca fácil, gana dinero.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        #map-container {
            height: 60vh;
        }
        /* Elegant, smaller icon style for Leaflet */
        .leaflet-div-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706); /* Amber Gradient */
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            font-size: 12px;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
        }
        .leaflet-div-icon:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        /* Estilos para el botón de vista activa */
        .view-btn.active {
            background-color: #4b5563; /* Gray */
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Animación para modales */
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-lg shadow-sm sticky top-0 z-40 border-b border-gray-200">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-3xl font-extrabold text-gray-800">Easy<span class="text-amber-500">Park</span></a>
                <div id="nav-right" class="hidden md:flex items-center space-x-4">
                    <!-- Contenido dinámico: Login vs. User -->
                </div>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
            <!-- Menú móvil -->
            <div id="mobile-menu" class="md:hidden hidden px-6 pb-4 space-y-2">
                 <!-- Contenido dinámico móvil -->
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="flex-grow">
            <!-- Hero Section -->
            <section class="bg-gray-900 text-white text-center py-24 px-4">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 tracking-tight">Aparca fácil, gana dinero.</h1>
                <p class="text-lg md:text-xl mb-10 max-w-3xl mx-auto text-gray-300">Encuentra un sitio libre al instante o alquila tu plaza de garaje por horas.</p>
                <div class="max-w-xl mx-auto">
                    <div class="relative shadow-2xl">
                        <input id="search-input" type="text" placeholder="Busca una ciudad, dirección o código postal..." class="w-full py-4 px-6 rounded-full text-gray-800 focus:outline-none focus:ring-4 focus:ring-amber-400 transition-shadow duration-300">
                        <button id="search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-full transition-transform duration-200 hover:scale-105">Buscar</button>
                    </div>
                </div>
            </section>

            <!-- Mapa y Resultados -->
            <section id="buscar" class="container mx-auto px-6 py-16">
                <h2 class="text-4xl font-bold text-center mb-10">Plazas disponibles</h2>

                <!-- Controles de vista y ordenación -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <div class="bg-white p-1 rounded-full shadow-md">
                        <button id="map-view-btn" class="view-btn active rounded-full px-5 py-2 text-sm font-semibold transition-colors duration-300">Mapa</button>
                        <button id="list-view-btn" class="view-btn rounded-full px-5 py-2 text-sm font-semibold transition-colors duration-300">Lista</button>
                    </div>
                    <div>
                        <label for="sort-select" class="font-semibold mr-2 text-gray-600">Ordenar por:</label>
                        <select id="sort-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white shadow-sm focus:ring-2 focus:ring-amber-500 focus:outline-none">
                            <option value="default">Recomendados</option>
                            <option value="price-asc">Precio (más bajo primero)</option>
                            <option value="price-desc">Precio (más alto primero)</option>
                            <option value="distance" disabled>Distancia (más cercano)</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-xl">
                    <!-- Contenedor del mapa real -->
                    <div id="map-container" class="w-full rounded-lg z-10"></div>
                    <!-- Contenedor de la lista -->
                    <div id="list-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4">
                        <!-- Las plazas se insertarán aquí -->
                    </div>
                </div>
            </section>
            
            <!-- How it Works Section -->
            <section class="bg-white py-20 px-6">
                <div class="container mx-auto text-center">
                    <h2 class="text-4xl font-bold mb-4">¿Cómo funciona EasyPark?</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto mb-12">Alquila o encuentra aparcamiento en tres sencillos pasos.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                        <!-- Step 1 -->
                        <div class="flex flex-col items-center">
                            <div class="bg-amber-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                               <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold mb-2">1. Busca</h3>
                            <p class="text-gray-600">Introduce tu destino y explora las plazas disponibles en el mapa o en la lista.</p>
                        </div>
                        <!-- Step 2 -->
                        <div class="flex flex-col items-center">
                             <div class="bg-amber-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                               <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold mb-2">2. Reserva</h3>
                            <p class="text-gray-600">Elige la plaza que mejor se adapte a ti, selecciona el tiempo y resérvala al instante.</p>
                        </div>
                        <!-- Step 3 -->
                        <div class="flex flex-col items-center">
                             <div class="bg-amber-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                               <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h3 class="text-xl font-bold mb-2">3. Aparca y Disfruta</h3>
                            <p class="text-gray-600">Dirígete a la plaza y aparca sin complicaciones. ¡Tu sitio te está esperando!</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white py-10">
            <div class="container mx-auto px-6 text-center text-gray-400">
                <p class="text-2xl font-bold text-white mb-2">Easy<span class="text-amber-500">Park</span></p>
                <p>&copy; 2025 EasyPark. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Modal de Login/Registro -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4 modal-content">
            <div class="flex justify-between items-center mb-6"><h3 id="modal-title" class="text-2xl font-bold">Bienvenido a EasyPark</h3><button id="close-login-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <form id="login-form">
                <div class="mb-4"><label for="email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="tu@email.com" required></div>
                <div class="mb-6"><label for="password" class="block text-gray-700 font-semibold mb-2">Contraseña</label><input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="********" required></div>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition-transform duration-200 hover:scale-105 shadow-md">Entrar</button>
                <p class="text-center text-sm text-gray-600 mt-4">¿No tienes cuenta? <a href="#" id="show-register-form" class="text-amber-600 hover:underline font-semibold">Regístrate</a></p>
            </form>
            <form id="register-form" class="hidden">
                 <div class="mb-4"><label for="reg-name" class="block text-gray-700 font-semibold mb-2">Nombre completo</label><input type="text" id="reg-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Tu nombre y apellidos" required></div>
                <div class="mb-4"><label for="reg-email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="reg-email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="tu@email.com" required></div>
                <div class="mb-4"><label for="reg-password" class="block text-gray-700 font-semibold mb-2">Contraseña</label><input type="password" id="reg-password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Crea una contraseña segura" required></div>
                <div class="my-6 border-t pt-4"><div class="flex items-center"><input id="offer-spots-checkbox" type="checkbox" class="h-4 w-4 text-amber-600 rounded border-gray-300 focus:ring-amber-500"><label for="offer-spots-checkbox" class="ml-2 block text-sm text-gray-900">Quiero añadir mis plazas de garaje</label></div></div>
                <div id="parking-spots-section" class="hidden"><div id="parking-spots-container"></div><button type="button" id="add-spot-btn" class="mt-2 text-sm text-amber-600 hover:text-amber-800 font-semibold">+ Añadir otra plaza</button></div>
                <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-transform duration-200 hover:scale-105 shadow-md">Crear cuenta</button>
                <p class="text-center text-sm text-gray-600 mt-4">¿Ya tienes cuenta? <a href="#" id="show-login-form" class="text-amber-600 hover:underline font-semibold">Inicia sesión</a></p>
            </form>
        </div>
    </div>

    <!-- Modal de Ofrecer Plaza -->
    <div id="offer-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4 modal-content">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Ofrecer una plaza</h3><button id="close-offer-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <form id="offer-spot-form">
                <div class="mb-4"><label for="spot-select" class="block text-gray-700 font-semibold mb-2">Elige tu plaza</label><select id="spot-select" class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-amber-500 focus:outline-none"></select></div>
                <div id="offer-details-section">
                    <p class="text-sm text-gray-600 mb-4 bg-gray-100 p-3 rounded-md">Dirección: <span id="offer-address" class="font-semibold block mt-1"></span></p>
                    <div class="mb-4"><label for="offer-hours" class="block text-gray-700 font-semibold mb-2">¿Por cuántas horas la ofreces?</label><input type="number" id="offer-hours" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="3" min="1" required></div>
                    <div class="mb-4"><label for="offer-price" class="block text-gray-700 font-semibold mb-2">Precio por hora (€)</label><input type="number" step="0.1" id="offer-price" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="2.50" min="0" required></div>
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg transition-transform duration-200 hover:scale-105 shadow-md">Publicar disponibilidad</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Mis Plazas -->
    <div id="my-spots-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl m-4 modal-content">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Gestionar Mis Plazas</h3><button id="close-my-spots-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
            <div id="my-spots-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Lista de plazas del usuario se insertará aquí -->
            </div>
            <button id="open-spot-editor-btn-new" class="mt-6 w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition-transform duration-200 hover:scale-105 shadow-md">Añadir Nueva Plaza</button>
        </div>
    </div>

    <!-- Modal Editor de Plaza -->
    <div id="spot-editor-modal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop hidden overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4 modal-content">
             <div class="flex justify-between items-center mb-4"><h3 id="spot-editor-title" class="text-2xl font-bold">Añadir Plaza</h3><button id="close-spot-editor-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button></div>
             <form id="spot-editor-form">
                <input type="hidden" id="spot-editor-index">
                <div class="mb-2"><label for="spot-editor-name" class="block text-sm font-semibold mb-1">Nombre de la plaza</label><input type="text" id="spot-editor-name" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Ej: Garaje de casa" required></div>
                <div class="mb-2"><label for="spot-editor-address" class="block text-sm font-semibold mb-1">Dirección</label><input type="text" id="spot-editor-address" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Calle Felipe II, 1, Sevilla" required></div>
                <div class="grid grid-cols-2 gap-4 mb-2"><div><label for="spot-editor-number" class="block text-sm font-semibold mb-1">Nº Plaza</label><input type="text" id="spot-editor-number" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="23"></div><div><label for="spot-editor-floor" class="block text-sm font-semibold mb-1">Planta</label><input type="text" id="spot-editor-floor" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="-1"></div></div>
                <div class="grid grid-cols-2 gap-4 mb-2"><div><label for="spot-editor-size" class="block text-sm font-semibold mb-1">Tamaño</label><select id="spot-editor-size" class="w-full px-3 py-2 border rounded-lg text-sm bg-white"><option value="Mediano">Mediano</option><option value="Pequeño">Pequeño</option><option value="Grande">Grande</option></select></div><div><label for="spot-editor-roof" class="block text-sm font-semibold mb-1">Techado</label><select id="spot-editor-roof" class="w-full px-3 py-2 border rounded-lg text-sm bg-white"><option value="Sí">Sí</option><option value="No">No</option></select></div></div>
                <div class="mb-4"><label for="spot-editor-photo" class="block text-sm font-semibold mb-1">Foto (opcional)</label><input type="file" id="spot-editor-photo" class="w-full text-sm"></div>
                <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg mt-4 transition-transform duration-200 hover:scale-105 shadow-md">Guardar Cambios</button>
             </form>
        </div>
    </div>


<!-- Leaflet JS for interactive maps --><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    let currentUser = { isLoggedIn: false, name: '', email: '', parkingSpots: [] };
    let userPhysicalLocation = null;
    let locationReference = null; // Guardará la ubicación del usuario o de la búsqueda
    const allParkingSpots = [
        { id: 1, name: 'Garaje Catedral', address: 'C. Alemanes, 20, Sevilla', price: 5.00, maxHours: 5, lat: 37.3858, lng: -5.9930, photoUrl: 'https://placehold.co/300x200/fbbf24/ffffff?text=Plaza+1', spotNumber: '15', floor: '-2', size: 'Grande', roofed: true },
        { id: 2, name: 'Parking Triana', address: 'C. Betis, 5, Triana, Sevilla', price: 3.75, maxHours: 8, lat: 37.3883, lng: -6.0011, photoUrl: 'https://placehold.co/300x200/f59e0b/ffffff?text=Plaza+2', spotNumber: '42', floor: '-1', size: 'Mediano', roofed: true },
        { id: 3, name: 'Aparcamiento Setas', address: 'Pl. de la Encarnación, 18, Sevilla', price: 4.20, maxHours: 3, lat: 37.3929, lng: -5.9904, photoUrl: 'https://placehold.co/300x200/d97706/ffffff?text=Plaza+3', spotNumber: '8', floor: '1', size: 'Pequeño', roofed: false },
        { id: 4, name: 'Plaza de España Sur', address: 'Av. de Isabel la Católica, 2, Sevilla', price: 4.50, maxHours: 6, lat: 37.3772, lng: -5.9869, photoUrl: null, spotNumber: '112', floor: '0', size: 'Mediano', roofed: true },
        { id: 5, name: 'Garaje El Porvenir', address: 'C. Felipe II, 1, El Porvenir, Sevilla', price: 3.90, maxHours: 7, lat: 37.3718, lng: -5.9825, photoUrl: 'https://placehold.co/300x200/ef4444/ffffff?text=Plaza+5', spotNumber: '31', floor: '-1', size: 'Grande', roofed: true },
    ];
    let currentlyDisplayedSpots = [...allParkingSpots];

    function saveUserToStorage() { localStorage.setItem('easyParkUser', JSON.stringify(currentUser)); }
    function loadUserFromStorage() { const storedUser = localStorage.getItem('easyParkUser'); if (storedUser) { currentUser = JSON.parse(storedUser); } }
    function clearUserFromStorage() { localStorage.removeItem('easyParkUser'); }

    function reserveSpot(spotId, price) {
        const hoursInput = document.getElementById(`reserve-hours-${spotId}`) || document.getElementById(`reserve-hours-card-${spotId}`);
        const hours = parseInt(hoursInput.value, 10);
        const maxHours = parseInt(hoursInput.max, 10);
        if (hours > 0 && hours <= maxHours) {
            alert(`¡Reserva confirmada!\n${hours} hora(s) por un total de ${(hours * price).toFixed(2)}€.`);
            const reserveModal = document.getElementById(`reserve-modal-${spotId}`);
            if(reserveModal) reserveModal.classList.add('hidden');
        } else {
            alert(`Por favor, introduce un número de horas válido (entre 1 y ${maxHours}).`);
        }
    }
    
    // Función para calcular distancia (Haversine)
    function haversineDistance(coords1, coords2) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371; // Radio de la Tierra en km
        const dLat = toRad(coords2.lat - coords1.lat);
        const dLon = toRad(coords2.lng - coords1.lng);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(coords1.lat)) * Math.cos(toRad(coords2.lat)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distancia en km
    }

    document.addEventListener('DOMContentLoaded', () => {
        const map = L.map('map-container').setView([37.3891, -5.9845], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
        let markerLayer = L.layerGroup().addTo(map);
        
        const listContainer = document.getElementById('list-container');
        const mapContainer = document.getElementById('map-container');
        const sortSelect = document.getElementById('sort-select');

        function renderMarkers(spots) {
            markerLayer.clearLayers();
            spots.forEach(spot => {
                if (!spot.lat || !spot.lng) return;
                const customIcon = L.divIcon({ className: 'leaflet-div-icon', html: `€${spot.price.toFixed(2)}`, iconSize: [40, 40], iconAnchor: [20, 20] });
                const marker = L.marker([spot.lat, spot.lng], { icon: customIcon }).addTo(markerLayer);
                marker.bindPopup(getPopupContent(spot, true));
            });
        }
        
        function getPopupContent(spot, isPopup = false) {
            const photoHtml = spot.photoUrl ? `<img src="${spot.photoUrl}" alt="Foto de la plaza" class="w-full h-32 object-cover rounded-lg mb-3">` : `<div class="w-full h-32 flex items-center justify-center bg-gray-200 rounded-lg mb-3"><p class="text-gray-500 text-sm">Sin foto</p></div>`;
            const distanceHtml = spot.distance ? `<div class="flex items-center text-sm text-amber-600 font-semibold"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>A ${spot.distance.toFixed(2)} km</div>` : '';
            
            const detailsHtml = `
                <div class="grid grid-cols-4 gap-2 text-center text-xs text-gray-600 my-3 py-2 border-t border-b">
                    <div class="flex flex-col items-center"><svg class="w-5 h-5 mb-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 8.25h13.5m-13.5 7.5h13.5m-1.65-13.5l-3.426 3.426m-3.426-3.426l3.426 3.426M21 12l-3.426-3.426m3.426 3.426l-3.426 3.426M3 12l3.426-3.426M3 12l3.426 3.426" /></svg><span class="font-bold">${spot.spotNumber || 'N/A'}</span></div>
                    <div class="flex flex-col items-center"><svg class="w-5 h-5 mb-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg><span class="font-bold">${spot.floor || 'N/A'}</span></div>
                    <div class="flex flex-col items-center"><svg class="w-5 h-5 mb-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m-11.25 6v4.5m0-4.5h4.5m-4.5 0L9 15m11.25 6v4.5m0-4.5h-4.5m4.5 0L15 15" /></svg><span class="font-bold">${spot.size || 'N/A'}</span></div>
                    <div class="flex flex-col items-center"><svg class="w-5 h-5 mb-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5z" /></svg><span class="font-bold">${spot.roofed ? 'Sí' : 'No'}</span></div>
                </div>`;
            
            const cardClass = isPopup ? 'w-52' : 'w-full';
            
            const reserveButtonHtml = `<button class="w-full bg-amber-500 text-white py-2 px-4 rounded-lg hover:bg-amber-600 text-sm font-semibold" onclick="document.getElementById('reserve-modal-${spot.id}').classList.remove('hidden')">Reservar</button>`;

            if(!document.getElementById(`reserve-modal-${spot.id}`)){ // Evita duplicar modales
                const modal = document.createElement('div');
                modal.id = `reserve-modal-${spot.id}`;
                modal.className = "fixed inset-0 z-[1000] flex items-center justify-center modal-backdrop hidden p-4";
                modal.onclick = () => modal.classList.add('hidden');
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm m-4 modal-content" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold mb-2">Reservar "${spot.name}"</h3>
                        <p class="text-sm text-gray-600 mb-4">${spot.address}</p>
                        <div class="text-center bg-gray-100 p-4 rounded-lg my-4">
                            <p class="text-gray-800">Precio por hora</p>
                            <p class="text-3xl font-bold text-gray-800">${spot.price.toFixed(2)}€</p>
                        </div>
                        <div class="mt-4">
                            <label for="reserve-hours-${spot.id}" class="block text-gray-700 font-semibold mb-2">¿Cuántas horas? (max ${spot.maxHours}h)</label>
                            <input type="number" id="reserve-hours-${spot.id}" class="w-full border rounded-lg px-3 py-2 text-center text-lg" value="1" min="1" max="${spot.maxHours}">
                        </div>
                        <button class="mt-6 w-full bg-amber-500 text-white py-3 px-4 rounded-lg hover:bg-amber-600 font-bold text-base" onclick="reserveSpot(${spot.id}, ${spot.price})">Confirmar Reserva</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            return `
                <div class="${cardClass} p-1">
                    ${isPopup ? '' : photoHtml}
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">${spot.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">${spot.address}</p>
                        </div>
                        ${distanceHtml}
                    </div>
                    ${!isPopup ? '' : photoHtml}
                    ${detailsHtml}
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-gray-800 font-bold text-xl">${spot.price.toFixed(2)} €<span class="text-sm font-medium text-gray-500">/hora</span></p>
                         ${isPopup ? reserveButtonHtml.replace('w-full', '') : ''}
                    </div>
                </div>`;
        }


        function renderList(spots) {
            listContainer.innerHTML = '';
            if (spots.length === 0) {
                listContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No se encontraron plazas con esos criterios.</p>';
                return;
            }
            spots.forEach(spot => {
                const spotCard = document.createElement('div');
                spotCard.className = 'border rounded-xl p-4 bg-white shadow-lg flex flex-col hover:shadow-2xl hover:-translate-y-1 transition-all duration-300';
                let content = getPopupContent(spot, false);
                const reserveButtonHtml = `<button class="w-full mt-4 bg-amber-500 text-white py-2 px-4 rounded-lg hover:bg-amber-600 text-sm font-semibold" onclick="document.getElementById('reserve-modal-${spot.id}').classList.remove('hidden')">Reservar</button>`;
                spotCard.innerHTML = content + reserveButtonHtml;
                listContainer.appendChild(spotCard);
            });
        }
        
        function updateView() {
            renderMarkers(currentlyDisplayedSpots);
            renderList(currentlyDisplayedSpots);
        }

        async function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const userCoords = { lat: position.coords.latitude, lng: position.coords.longitude };
                    userPhysicalLocation = userCoords;
                    locationReference = userCoords;
                    map.setView([userCoords.lat, userCoords.lng], 14);
                    L.circleMarker([userCoords.lat, userCoords.lng], { radius: 8, color: '#d97706', fillColor: '#f59e0b', fillOpacity: 1 }).addTo(map).bindPopup('Tu ubicación').openPopup();
                    sortSelect.querySelector('option[value="distance"]').disabled = false;
                }, () => { 
                    console.warn('El usuario denegó la geolocalización.'); 
                });
            }
        }

        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        async function performSearch() {
            const query = searchInput.value;
            
            if (query.trim() === '') {
                currentlyDisplayedSpots = [...allParkingSpots];
                if (userPhysicalLocation) {
                    locationReference = userPhysicalLocation;
                    map.setView([userPhysicalLocation.lat, userPhysicalLocation.lng], 13);
                }
            } else {
                let apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                
                if (userPhysicalLocation) {
                    const viewBox = [
                        userPhysicalLocation.lng - 1,
                        userPhysicalLocation.lat + 1,
                        userPhysicalLocation.lng + 1,
                        userPhysicalLocation.lat - 1
                    ].join(',');
                    apiUrl += `&viewbox=${viewBox}&bounded=1`;
                }
                
                try {
                    let data;
                    const response = await fetch(apiUrl);
                    data = await response.json();

                    if (!data || data.length === 0) {
                        const fallbackApiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                        const fallbackResponse = await fetch(fallbackApiUrl);
                        data = await fallbackResponse.json();
                    }

                    if (data && data.length > 0) {
                       const { lat, lon } = data[0];
                       locationReference = { lat: parseFloat(lat), lng: parseFloat(lon) };
                       map.setView([lat, lon], 15);
                       sortSelect.querySelector('option[value="distance"]').disabled = false;
                    } else {
                       alert('No se encontraron resultados para tu búsqueda.');
                    }
                } catch (error) { 
                    console.error("Error de geocodificación:", error); 
                    alert('Hubo un error al realizar la búsqueda.');
                }
                
                const lowerCaseQuery = query.toLowerCase();
                currentlyDisplayedSpots = allParkingSpots.filter(spot => spot.name.toLowerCase().includes(lowerCaseQuery) || spot.address.toLowerCase().includes(lowerCaseQuery));
            }
            
            updateView();
            document.getElementById('buscar').scrollIntoView({ behavior: 'smooth' });
        }
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });


        const mapViewBtn = document.getElementById('map-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        mapViewBtn.addEventListener('click', () => { mapContainer.classList.remove('hidden'); listContainer.classList.add('hidden'); mapViewBtn.classList.add('active'); listViewBtn.classList.remove('active'); map.invalidateSize(); });
        listViewBtn.addEventListener('click', () => { mapContainer.classList.add('hidden'); listContainer.classList.remove('hidden'); mapViewBtn.classList.remove('active'); listViewBtn.classList.add('active'); });

        sortSelect.addEventListener('change', () => {
            const sortBy = sortSelect.value;
            if (sortBy === 'price-asc') currentlyDisplayedSpots.sort((a, b) => a.price - b.price);
            else if (sortBy === 'price-desc') currentlyDisplayedSpots.sort((a, b) => b.price - a.price);
            else if (sortBy === 'distance' && locationReference) {
                currentlyDisplayedSpots.forEach(spot => { spot.distance = haversineDistance(locationReference, spot); });
                currentlyDisplayedSpots.sort((a, b) => a.distance - b.distance);
            }
            updateView();
        });

        // --- Lógica de UI y Modales ---
        const loginModal = document.getElementById('login-modal'); const offerModal = document.getElementById('offer-modal'); const mySpotsModal = document.getElementById('my-spots-modal'); const spotEditorModal = document.getElementById('spot-editor-modal'); const closeLoginBtn = document.getElementById('close-login-modal-btn'); const closeOfferBtn = document.getElementById('close-offer-modal-btn'); const closeMySpotsBtn = document.getElementById('close-my-spots-modal-btn'); const closeSpotEditorBtn = document.getElementById('close-spot-editor-modal-btn'); const menuBtn = document.getElementById('menu-btn'); const mobileMenu = document.getElementById('mobile-menu'); const navRight = document.getElementById('nav-right'); 
        function updateUI() { 
            if (currentUser.isLoggedIn) { 
                const loggedInNav = `<span class="text-gray-700 font-semibold">Hola, ${currentUser.name.split(' ')[0]}</span> <button data-action="open-my-spots" class="text-gray-600 hover:text-amber-600 font-semibold py-2 px-3 rounded-lg transition duration-300">Mis Plazas</button> <button data-action="open-offer" class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Ofrecer mi plaza</button> <button data-action="logout" class="text-gray-600 hover:text-amber-600">Cerrar Sesión</button>`; 
                const loggedInMobileNav = `<span class="block text-gray-700 font-semibold px-4 py-2">Hola, ${currentUser.name.split(' ')[0]}</span> <button data-action="open-my-spots" class="w-full text-left text-gray-600 hover:text-amber-600 font-semibold py-2 px-4">Mis Plazas</button> <button data-action="open-offer" class="w-full text-left bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Ofrecer mi plaza</button> <button data-action="logout" class="w-full text-left text-gray-600 hover:text-amber-600 px-4 py-2">Cerrar Sesión</button>`; 
                navRight.innerHTML = loggedInNav; mobileMenu.innerHTML = loggedInMobileNav; 
            } else { 
                const loggedOutNav = `<a href="#buscar" class="text-gray-600 hover:text-amber-600">Buscar Aparcamiento</a> <button data-action="open-login" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Login / Registro</button>`; 
                const loggedOutMobileNav = `<a href="#buscar" class="block text-gray-600 hover:text-amber-600 px-4 py-2">Buscar Aparcamiento</a> <button data-action="open-login" class="w-full text-left bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Login / Registro</button>`; 
                navRight.innerHTML = loggedOutNav; mobileMenu.innerHTML = loggedOutMobileNav; 
            } 
        } 
        
        const modalTitle = document.getElementById('modal-title'); const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form'); const showRegisterLink = document.getElementById('show-register-form'); const showLoginLink = document.getElementById('show-login-form'); showRegisterLink.addEventListener('click', e => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); modalTitle.textContent = 'Crea tu cuenta'; }); showLoginLink.addEventListener('click', e => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); modalTitle.textContent = 'Bienvenido a EasyPark'; }); const offerSpotsCheckbox = document.getElementById('offer-spots-checkbox'); const parkingSpotsSection = document.getElementById('parking-spots-section'); const parkingSpotsContainer = document.getElementById('parking-spots-container'); const addSpotBtn = document.getElementById('add-spot-btn'); let spotCounter = 0; 
        
        function createSpotForm() { 
            spotCounter++; 
            const div = document.createElement('div'); 
            div.className = 'spot-form-group border-t-2 border-dashed pt-4 mt-4 relative'; 
            div.innerHTML = ` ${spotCounter > 1 ? '<button type="button" class="remove-spot-btn absolute top-2 right-0 text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>' : ''} <p class="font-semibold text-gray-700 mb-2">Plaza de Garaje #${spotCounter}</p> <div class="mb-2"><label for="spot-name-${spotCounter}" class="block text-sm font-semibold mb-1">Nombre de la plaza</label><input type="text" name="spot_name" id="spot-name-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ej: Garaje de casa" required></div> <div class="mb-2"><label for="spot-address-${spotCounter}" class="block text-sm font-semibold mb-1">Dirección</label><input type="text" name="spot_address" id="spot-address-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Calle Felipe II, 1, Sevilla" required></div> <div class="grid grid-cols-2 gap-4 mb-2"><div><label for="spot-number-${spotCounter}" class="block text-sm font-semibold mb-1">Nº Plaza</label><input type="text" name="spot_number" id="spot-number-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="23"></div><div><label for="spot-floor-${spotCounter}" class="block text-sm font-semibold mb-1">Planta</label><input type="text" name="spot_floor" id="spot-floor-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="-1"></div></div> <div class="grid grid-cols-2 gap-4 mb-2"><div><label for="spot-size-${spotCounter}" class="block text-sm font-semibold mb-1">Tamaño</label><select name="spot_size" id="spot-size-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm bg-white"><option value="Mediano">Mediano</option><option value="Pequeño">Pequeño</option><option value="Grande">Grande</option></select></div><div><label for="spot-roof-${spotCounter}" class="block text-sm font-semibold mb-1">Techado</label><select name="spot_roof" id="spot-roof-${spotCounter}" class="w-full px-3 py-2 border rounded-lg text-sm bg-white"><option value="Sí">Sí</option><option value="No">No</option></select></div></div> <div class="mb-2"><label for="spot-photo-${spotCounter}" class="block text-sm font-semibold mb-1">Foto (opcional)</label><input type="file" name="spot_photo" id="spot-photo-${spotCounter}" class="w-full text-sm"></div>`; 
            parkingSpotsContainer.appendChild(div); 
        } 
        offerSpotsCheckbox.addEventListener('change', () => { if (offerSpotsCheckbox.checked) { parkingSpotsSection.classList.remove('hidden'); if (spotCounter === 0) createSpotForm(); } else { parkingSpotsSection.classList.add('hidden'); parkingSpotsContainer.innerHTML = ''; spotCounter = 0; } }); addSpotBtn.addEventListener('click', createSpotForm); parkingSpotsContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-spot-btn')) e.target.parentElement.remove(); }); 
        
        const spotSelect = document.getElementById('spot-select'); const offerAddress = document.getElementById('offer-address'); const offerDetailsSection = document.getElementById('offer-details-section'); 
        function populateOfferModal() { 
            spotSelect.innerHTML = ''; 
            if (currentUser.parkingSpots.length === 0) { 
                spotSelect.innerHTML = '<option disabled selected>No tienes plazas registradas</option>'; 
                offerDetailsSection.classList.add('hidden'); 
            } else { 
                currentUser.parkingSpots.forEach((spot, index) => { const option = document.createElement('option'); option.value = index; option.textContent = spot.name; spotSelect.appendChild(option); }); 
                offerDetailsSection.classList.remove('hidden'); 
                offerAddress.textContent = currentUser.parkingSpots[0].address; 
            } 
        } 
        spotSelect.addEventListener('change', () => { const selectedIndex = spotSelect.value; offerAddress.textContent = currentUser.parkingSpots[selectedIndex].address; }); 
        
        menuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden')); 
        document.body.addEventListener('click', e => { 
            const action = e.target.dataset.action; 
            if (action === 'open-login') loginModal.classList.remove('hidden'); 
            if (action === 'open-offer') { populateOfferModal(); offerModal.classList.remove('hidden'); } 
            if (action === 'open-my-spots') { renderMySpotsList(); mySpotsModal.classList.remove('hidden'); }
            if (action === 'logout') { 
                clearUserFromStorage(); 
                currentUser = { isLoggedIn: false, name: '', email: '', parkingSpots: [] }; 
                window.location.reload();
            } 
        }); 
        
        closeLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden')); 
        closeOfferBtn.addEventListener('click', () => offerModal.classList.add('hidden')); 
        closeMySpotsBtn.addEventListener('click', () => mySpotsModal.classList.add('hidden'));
        closeSpotEditorBtn.addEventListener('click', () => spotEditorModal.classList.add('hidden'));
        [loginModal, offerModal, mySpotsModal, spotEditorModal].forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
        });
        
        loginForm.addEventListener('submit', e => { e.preventDefault(); const email = document.getElementById('email').value; const storedUserJSON = localStorage.getItem('easyParkUser'); if (storedUserJSON) { const storedUser = JSON.parse(storedUserJSON); if (storedUser.email === email) { currentUser = storedUser; currentUser.isLoggedIn = true; saveUserToStorage(); alert(`¡Bienvenido de nuevo, ${currentUser.name.split(' ')[0]}!`); loginModal.classList.add('hidden'); updateUI(); return; } } alert('Usuario no encontrado o contraseña incorrecta.'); });
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = registerForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Creando cuenta...';
            currentUser.isLoggedIn = true;
            currentUser.name = document.getElementById('reg-name').value;
            currentUser.email = document.getElementById('reg-email').value;
            currentUser.parkingSpots = [];
            const spotForms = Array.from(parkingSpotsContainer.querySelectorAll('.spot-form-group'));
            const newSpots = await Promise.all(spotForms.map(form => processSpotForm(form)));
            currentUser.parkingSpots = newSpots;
            submitButton.disabled = false;
            submitButton.textContent = 'Crear cuenta';
            let message = `¡Bienvenido, ${currentUser.name.split(' ')[0]}! Tu cuenta ha sido creada.`;
            if (spotForms.length > 0) message += `\nHas registrado ${spotForms.length} plaza(s).`;
            saveUserToStorage();
            alert(message);
            loginModal.classList.add('hidden');
            updateUI();
        });

        document.getElementById('offer-spot-form').addEventListener('submit', e => {
            e.preventDefault();
            const selectedSpotIndex = spotSelect.value;
            const userSpot = currentUser.parkingSpots[selectedSpotIndex];
            const hours = document.getElementById('offer-hours').value;
            const price = document.getElementById('offer-price').value;
            if (!userSpot || !hours || !price) { alert('Por favor, completa todos los campos.'); return; }
            const newOfferedSpot = { id: allParkingSpots.length + 1, price: parseFloat(price), maxHours: parseInt(hours), ...userSpot, photoUrl: userSpot.photoUrl || 'https://placehold.co/300x200/a855f7/ffffff?text=Mi+Plaza' };
            allParkingSpots.push(newOfferedSpot);
            currentlyDisplayedSpots = [...allParkingSpots];
            sortSelect.value = 'default';
            updateView();
            map.panTo([newOfferedSpot.lat, newOfferedSpot.lng]);
            alert('¡Disponibilidad de la plaza publicada con éxito!');
            offerModal.classList.add('hidden');
        });
        
        // --- Nueva Lógica de Gestión de Plazas ---
        const mySpotsList = document.getElementById('my-spots-list');
        const spotEditorForm = document.getElementById('spot-editor-form');

        function renderMySpotsList() {
            mySpotsList.innerHTML = '';
            if (currentUser.parkingSpots.length === 0) {
                mySpotsList.innerHTML = `<p class="text-center text-gray-500 py-4">Aún no has añadido ninguna plaza.</p>`;
                return;
            }
            currentUser.parkingSpots.forEach((spot, index) => {
                const spotEl = document.createElement('div');
                spotEl.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-lg transition-shadow hover:shadow-md';
                spotEl.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${spot.name}</p>
                        <p class="text-sm text-gray-600">${spot.address}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-action="edit-spot" data-index="${index}" class="text-sm bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">Editar</button>
                        <button data-action="delete-spot" data-index="${index}" class="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Eliminar</button>
                    </div>
                `;
                mySpotsList.appendChild(spotEl);
            });
        }
        
        mySpotsList.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            const index = e.target.dataset.index;
            if (action === 'edit-spot') {
                openSpotEditor(index);
            } else if (action === 'delete-spot') {
                if(confirm(`¿Estás seguro de que quieres eliminar la plaza "${currentUser.parkingSpots[index].name}"?`)) {
                    currentUser.parkingSpots.splice(index, 1);
                    saveUserToStorage();
                    renderMySpotsList();
                }
            }
        });

        document.getElementById('open-spot-editor-btn-new').addEventListener('click', () => openSpotEditor());

        function openSpotEditor(index = null) {
            const isEditing = index !== null;
            document.getElementById('spot-editor-title').textContent = isEditing ? 'Editar Plaza' : 'Añadir Nueva Plaza';
            spotEditorForm.reset();
            document.getElementById('spot-editor-index').value = index ?? '';
            if (isEditing) {
                const spot = currentUser.parkingSpots[index];
                document.getElementById('spot-editor-name').value = spot.name;
                document.getElementById('spot-editor-address').value = spot.address;
                document.getElementById('spot-editor-number').value = spot.spotNumber || '';
                document.getElementById('spot-editor-floor').value = spot.floor || '';
                document.getElementById('spot-editor-size').value = spot.size || 'Mediano';
                document.getElementById('spot-editor-roof').value = spot.roofed ? 'Sí' : 'No';
            }
            spotEditorModal.classList.remove('hidden');
        }

        async function processSpotForm(form) {
            const name = form.querySelector('[name=spot_name]').value;
            const address = form.querySelector('[name=spot_address]').value;
            const spotNumber = form.querySelector('[name=spot_number]').value;
            const floor = form.querySelector('[name=spot_floor]').value;
            const size = form.querySelector('[name=spot_size]').value;
            const roofed = form.querySelector('[name=spot_roof]').value === 'Sí';
            let lat = null, lng = null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) { lat = parseFloat(data[0].lat); lng = parseFloat(data[0].lon); } 
                else { console.warn(`No se pudo geocodificar: ${address}`); }
            } catch (error) { console.error(`Error geocodificando ${address}:`, error); }
            return { name, address, photoUrl: null, lat, lng, spotNumber, floor, size, roofed };
        }

        spotEditorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const index = document.getElementById('spot-editor-index').value;
            const isEditing = index !== '';
            
            const spotData = {
                name: document.getElementById('spot-editor-name').value,
                address: document.getElementById('spot-editor-address').value,
                spotNumber: document.getElementById('spot-editor-number').value,
                floor: document.getElementById('spot-editor-floor').value,
                size: document.getElementById('spot-editor-size').value,
                roofed: document.getElementById('spot-editor-roof').value === 'Sí',
                photoUrl: null // La gestión de fotos no se implementa completamente
            };

            let lat = null, lng = null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(spotData.address)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) { lat = parseFloat(data[0].lat); lng = parseFloat(data[0].lon); }
            } catch (error) { console.error('Error de geocodificación:', error); }
            spotData.lat = lat;
            spotData.lng = lng;

            if (isEditing) {
                currentUser.parkingSpots[index] = spotData;
            } else {
                currentUser.parkingSpots.push(spotData);
            }

            saveUserToStorage();
            renderMySpotsList();
            spotEditorModal.classList.add('hidden');
        });

        // --- Inicialización ---
        loadUserFromStorage();
        if(currentUser.isLoggedIn) {
            updateUI();
        }
        getUserLocation();
        updateView();
        updateUI();
    });
</script>

</body>
</html>
